var PB_Global_StateDefiner;
(function(K,g){function y(u,c,a,f,d,e,z,t,m,q){var h=function(b){if(g.isString(b)){var a=e.document.getElementById(b);if(a)return g.element(a);a=e.document.getElementsByName(b);return g.element(a)}return g.element(b)},s=function(b){for(;0!=b.length&&"FORM"!=b.prop("tagName")&&"NG-FORM"!=b.prop("tagName");)b=b.parent();return b},n=function(b,a,l,d,n,E){var f,r,x,g,k,z,m,t=!0;l&&(l["ajax-data"]&&(z=l["ajax-data"]),l["ajax-form"]&&(f=h(l["ajax-form"])),l["ajax-url"]&&(r=l["ajax-url"]),l["ajax-bind"]&&
(g=l["ajax-bind"]),l["ajax-processing"]&&(x=l["ajax-processing"]),l["ajax-method"]&&(k=l["ajax-method"]));if("undefined"==typeof f&&"undefined"!=typeof b)if("FORM"==h(b).prop("tagName")||"NG-FORM"==h(b).prop("tagName"))f=h(b);else{var u=h(b).attr("ajax-form");if("undefined"!=typeof u){if(""!=u&&(f=h(u),0==f.length)){e.alert("form not found,id="+u);return}}else f=s(h(b))}if("undefined"==typeof r||""==r)r=h(b).attr("ajax-url")||h(f).attr("ajax-url");if("undefined"==typeof r||""==r)return e.alert("need value for ajax-url!");
"undefined"==typeof x&&(x=h(b).attr("ajax-processing")||h(f).attr("id"));"undefined"==typeof k&&(k=h(b).attr("ajax-method")||h(f).attr("ajax-method")||"POST");"undefined"==typeof g&&(g=h(b).attr("ajax-bind")||h(f).attr("ajax-bind"));"undefined"==typeof g&&l&&!l["ajax-bind"]&&(g="nobind");if("nobind"==g)t=!1;else if("parent"==g){if(m=h(b).parent().controller(),null==m&&(m=h(f).controller()),null==m){e.alert("ajax-bind=parent targets no controller!");return}}else if("undefined"==typeof g||""==g)if(m=
h(b).controller(),null==m&&(m=h(f).controller()),null==m){e.alert("an default ajax-bind targets no controller!");return}if(t&&null==m)if("undefined"==typeof x&&(x=g),"undefined"!=typeof h(g).attr("ui-view")){if(m=h(g).children().eq(0).controller(),null==m){e.alert("bindTargetId:"+g+" targets a ui-view which has not a controller!");return}}else{e.alert("bindTargetId:"+g+" should target an ui-view !");return}var v;if(0<h(f).length){if(!w(f))return;v=F(f)}l=G(v,z);r=r.split("?");r=r[0]+"?"+p.KeyForViewModelOnly+
"=true"+(r[1]?"&"+r[1]:"");q.PutProcessing(x);a=c({method:k,url:r,data:l,params:a}).success(function(a,l,D,c){B(a);t&&a.IsVM&&(m.vm=a.data.ViewModel);!0==a.isRcResult?d?!0!=E&&A(a):((l=h(b).controller())&&l.ExecuteResult?l.ExecuteResult(h(b).attr("id"),a):A(a),a.IsNoop&&l&&l.ExecuteNoopResult&&l.ExecuteNoopResult(h(b).attr("id"))):!1==a.isRcResult&&y(a);q.PutProcessing(!1)}).error(function(b,a,l,D,c){q.Alert(a);q.PutProcessing(!1)});return d?a.then(function(b){if(!0==b.data.isRcResult)return d(b.data,
n)}):a},F=function(b){var a=/\r?\n/g,l=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,c=/^(?:select|textarea)/i,d=b.find("input"),f=b.find("textarea");b=b.find("select");var h=[],n=function(b,d){if(("INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName)&&b.name&&"_"!=b.name.substring(0,1)&&!b.disabled&&(b.checked||c.test(b.nodeName)||l.test(b.type))){var f=g.element(b).attr("name"),n=g.element(b).val();g.isArray(n)?g.forEach(n,
function(b,l){b=b.replace(a,"\r\n");h[h.length]=e.encodeURIComponent(f)+"="+e.encodeURIComponent(b)}):(n=n.replace(a,"\r\n"),"radio"==b.type&&"on"==n&&(n=""),h[h.length]=e.encodeURIComponent(f)+"="+e.encodeURIComponent(n))}};g.forEach(d,n);g.forEach(f,n);g.forEach(b,n);return h.join("&").replace(/%20/g,"+").replace(/number%3A/g,"")},w=function(b){var a=h(b).controller("form");if(a.$invalid){var l=!0,c;for(c in a.$error){for(var d=a.$error[c],e=0;e<d.length;e++)if(d[e].$name.substring(0,1)!=p.UnSubmitNameMarker){l=
!1;break}if(!l)break}if(!l)return u.validateForm(b),!1}return!0},A=function(b,c){c&&b.IsVM?c.vm=b.data.ViewModel:b.IsMsg?H(b.data):b.IsRedirect?a.go(b.data):b.IsAppPage&&(e.location=b.data)},y=function(b){b.IsMsg?q.Alert(b.data):b.IsRedirect?a.go(b.data):b.IsAppPage?e.location=b.data:q.ShowCommand(b.command,b.data)},H=function(b){f(b).then(function(b){e.alert(b)},function(b){e.alert(b)})},I=function(b){for(var a=b.length,l=0;l<a;l++)if(null!=b[l]&&!1!=b[l])return!0;return!1},J=function(b,a){b||(b=
"ConfirmDelete");return g.isString(a)?q.Confirm(b,a):a?q.Confirm("ConfirmDeleteMulti"):q.Alert("NoRowSelected").then(function(){return!1})},G=function(b,a){if("undefined"==typeof b)return"undefined"==typeof a?"":a;if("undefined"==typeof a)return b;if(""==b||""==a)return b+a;for(var l=b.split("&"),c=a.split("&"),d="",e="",f="",n=0;n<c.length;n++){for(var h=c[n].split("="),g=!1,s=0;s<l.length;s++)if(l[s].split("=")[0].toLowerCase()==h[0].toLowerCase()){l[s]=c[n];g=!0;break}g||""==c[n]||(f=f+c[n]+"&")}for(n=
0;n<l.length;n++)e=e+l[n]+"&";e.endWith("&")&&(d=e);f.endWith("&")&&(d+=f);d.endWith("&")&&(d=d.substr(0,d.length-1));return d},C=function(b,a,c){a||c||(a=p.Command_AjaxNavVM,c={ViewModel:null});return{result:b,command:a,data:c}};return{AjaxSubmit:function(b,a,c,f,g,s){var k,m="";null==b&&(b=void 0);if(b&&(b=h(b),1<b.length&&(b=b.eq(0)),1>b.length)){e.alert("param control's indicated no control");return}if("undefined"!=typeof h(b).attr("ajax-confirm")||"undefined"!=typeof h(b).attr("ajax-confirm-single")||
"undefined"!=typeof h(b).attr("ajax-confirm-multi"))k=h(b).attr("ajax-confirm"),"undefined"!=typeof h(b).attr("ajax-confirm-single")?m=h(b).attr("ajax-confirm-single"):"undefined"!=typeof h(b).attr("ajax-confirm-multi")&&(m=d(h(b).attr("ajax-confirm-multi"))(h(b).scope()),m=I(m)),J(k,m).then(function(d){if(!0==d)return n(b,a,c,f,g,s)});else return n(b,a,c,f,g,s)},CallAction:function(b,a,d,e,f){b=b.split("?");b=b[0]+"?"+p.KeyForViewModelOnly+"=true"+(b[1]?"&"+b[1]:"");a=c({method:"POST",url:b,data:a}).success(function(b,
a,c,d){B(b);!0==b.isRcResult&&!0!=f?A(b):!1==b.isRcResult&&y(b)}).error(function(b,a,c,d){q.Alert(a)});return d?a.then(function(b){if(!0==b.data.isRcResult)return d(b.data,e)}):a},ExecuteResult:A,AjaxNavRegister:function(b,c,d,e,f){if(d!=b&&b.name!=v.PrevState&&!(0<k.Stack.length&&b==k.Stack[k.Stack.length-1].State)){var n,h={};c&&c["ajax-nav"]&&(n=g.lowercase(c["ajax-nav"]));var s=g.lowercase(c["ajax-nav-back"]);if(f){if("forward"==n&&(1==k.Stack.length&&null==k.Stack[0].State&&(k.Stack[0].State=
d),b=k.Stack[k.Stack.length-1],d==b.State)){var m=b.State;do m.views?g.forEach(m.views,function(b,a){var c=m.name+".views_"+a;k.ControllerDataMapForCache[c]&&(h[c]=k.ControllerDataMapForCache[c].vm)}):k.ControllerDataMapForCache[m.name]&&(h[m.name]=k.ControllerDataMapForCache[m.name].vm),m=a.get(m.parent);while(!m.name.startWith("/Shared/"));b.StateData=h}k.ControllerDataMapForCache={}}else s||(n=n||"root",d={PrevState:d,PrevStateParams:e,State:b,StateParams:c,StateData:null},"root"==n?(k.Stack=[v],
k.Stack[0].State=b,k.Stack[0].StateParams=c):"forward"==n?k.Stack.push(d):alert("nav has invalid value!"))}},AjaxNavGetBackSrc:function(b,a){var c=a?a["ajax-nav-back"]:void 0,d=c?c.startWith("back:"):!1;if(c&&d){var e=C();e.data.ViewModel=k.Stack[k.Stack.length-1].StateData[b];return{IsBack:d,BackFrom:d?c.substring(5,c.length):void 0,LastData:e}}return!1},AjaxNavBack:function(){var b=k.Stack.pop(),c;b.PrevStateParams&&(c=g.copy(b.PrevStateParams),c["ajax-nav-back"]="back:"+a.current.name);a.transitionTo(b.PrevState,
c,{reload:!1,inherit:!1,notify:!0})},AjaxNavRefresh:function(){a.go(k.Stack[k.Stack.length-1].State,k.Stack[k.Stack.length-1].StateParams,{inherit:!1,reload:!0})},AjaxNavTo:function(b,c){for(;0<k.Stack.length&&b!=k.Stack[k.Stack.length-1].State;)k.Stack.pop();a.go(b,c,{inherit:!1,reload:!0})},CreateRcResult:C,AjaxNavData:k,ElementById:h,Super:function(b,a,c){b.vm=a;b.tmp={};var d=b.__proto__._DefinedBy;if(!d.startWith("/Shared/")){k.ControllerDataMapForCache[d]=b;for(var e in b.__proto__._UsedBy)k.ControllerDataMapForCache[e]=
b}var n=b.__proto__._NavBackRefresh;n&&c.$on("$viewContentLoaded",function(b){a._FromResult&&a._FromResult.command==p.Command_AjaxNavVM&&t(function(){z.invoke(n)})});return b},ValidateUtil:{SetPristine:function(b,a){g.forEach(b.PB_Group[a],function(a,c){b[c].$setPristine()})},Validate:function(b,a){var c=!0;g.forEach(b.PB_Group[a],function(b,a){var d=b.controller("ngModel");d.$invalid&&(c=!1,u.validateElement(d,b,{disabled:!1,forceValidation:!0}))});return c}}}}var v={PrevState:"tobeset",PrevStateParams:null,
State:null,StateParams:null,StateData:null},k={ControllerDataMapForCache:{},Stack:[v]},p={DefaultPopupWindowFeature:"height=600, width=600, top=50, left=300, toolbar=yes, menubar=no, scrollbars=yes, resizable=yes,location=no, status=no",AuthFailure:"_AuthFailure",AuthFailureMaskElementId:"divAuthFailureMask",KeyForViewModelOnly:"_ForViewModelOnly",Command_Noop:"Noop",Command_Message:"Message",Command_Redirect:"Redirect",Command_AppPage:"AppPage",Command_ServerVM:"ServerVM",Command_ServerData:"ServerData",
Command_AjaxNavVM:"AjaxNavVM",Command_HttpStatus:"HttpStatus",UrlMappingPrefix:"tobeset",AutoControllerMarker:"PB_Auto",UnSubmitNameMarker:"_"},B=function(g){var c=g.command;c==p.Command_ServerVM||g.command==p.Command_AjaxNavVM?g.IsVM=!0:c==p.Command_Message?g.IsMsg=!0:c==p.Command_ServerData?g.IsData=!0:c==p.Command_Noop?g.IsNoop=!0:c==p.Command_Redirect?g.IsRedirect=!0:c==p.Command_AppPage&&(g.IsAppPage=!0)};PB_Global_StateDefiner=function(k){var c=this;c.ns="";c.DefaultLayout="";c.tmpStates={};
c.SetDefaultLayout=function(a){c.DefaultLayout=a};c.SetUrlMappingPrefix=function(a){p.UrlMappingPrefix=a};c.SetAjaxNavRootState=function(a){v.PrevState=a};c.CreateWrappedState=function(a,f,d,e,k){var t=k?!0:!1,m,q,h;g.isString(a)&&(q=(a.startWith("/")?"":c.ns)+a,m=e?q.substring(0,q.indexOf(".")):q,0<m.indexOf("?")&&(m=m.substring(0,m.indexOf("?"))),t?(a={name:e?a.substring(0,a.indexOf(".")):a,templateUrl:e?q:null,controller:p.AutoControllerMarker,controllerAs:"c",resolve:null},h=k+".views_"+a.name):
(a={name:m,url:m+(f?"?"+f:""),templateUrl:e?q:null,controller:p.AutoControllerMarker,controllerAs:"c",params:{"ajax-nav":{value:void 0,squash:!0,array:!1},"ajax-nav-back":{value:void 0,squash:!0,array:!1}},reloadOnSearch:!1,resolve:null,"abstract":!1,parent:"undefined"==typeof d?c.DefaultLayout:d},h=a.name),e||(e=["pb","$stateParams",function(a,c){var d=a.AjaxNavGetBackSrc(h,c);return d&&d.IsBack?d.LastData:!1}],k=["pb","customizedResultGetter","$stateParams",function(a,c,d){if(c)return c;c=p.UrlMappingPrefix+
m;if(!c)return null;d=g.copy(d);delete d["ajax-nav"];delete d["ajax-nav-back"];return a.AjaxSubmit(null,d,{"ajax-url":c,"ajax-bind":"nobind","ajax-method":"GET"},function(a){return a})}],f=["pb","serverResult",function(a,c){B(c);if(c.IsVM)return c.data.ViewModel._FromResult=c,c.data.ViewModel;if(!1==c.isRcResult)throw c;return{}}],a.templateUrl=function(){return p.UrlMappingPrefix+q},a.resolve={customizedResultGetter:e,serverResult:k,serverVm:f}));t||!a||a.data||(a.data={});return{isForView:t,state:a,
WithController:function(a){var d;this.isForView?(d=this.OwnerState.views[a],a=this.OwnerState.name+".views_"+d.name):(a=(a.startWith("/")?"":c.ns)+a,d=c.tmpStates[a],a=d.name);this.state.controller=d.controller;this.state.templateUrl=d.templateUrl;this.state.templateUrlFn=d.templateUrlFn;d=d.controller;if(d=g.isArray(d)?d[d.length-1]:d)d.prototype._UsedBy=d.prototype._UsedBy||{},d.prototype._UsedBy[a]=!0;return this},WithChild:function(a,d){if(this.isForView)throw"WithChild is only for state to use";
var e=a.endWith(".htm")||a.endWith(".html"),e=c.CreateWrappedState(a,d,this.state.name,e);c.tmpStates[e.state.name]=e.state;this.state["abstract"]=!0;return e},Controller:function(a){this.state.controller=a;if(a=g.isArray(a)?a[a.length-1]:a)a.prototype._DefinedBy=this.isForView?this.OwnerState.name+".views_"+this.state.name:this.state.name;return this},NoController:function(){this.state.controller=null;this.state.controllerAs=null;return this},NoResolve:function(){this.state.resolve=null;return this},
ResultGetter:function(a){this.state.resolve.customizedResultGetter=a;return this},NavBackRefresh:function(a){a?this.Tmp_NavBackRefresh=a:this.state.resolve.customizedResultGetter=function(){return!1};return this},ForceViewByAction:function(a){a||(a=this.state.name);this.state.templateUrl=p.UrlMappingPrefix+a+"?"+p.KeyForViewModelOnly+"=false";this.state.templateFn=null;return this},BranchView:function(a,d){if(!this.isForView)throw"meant to be called by a wrapped view";var e=a.endWith(".htm")||
a.endWith(".html"),e=c.CreateWrappedState(a,d,void 0,e,this.OwnerState.name);this.OwnerState.views[e.state.name]=e.state;e.OwnerState=this.OwnerState;return e}}};c.RootState=function(a,f){var d=a.endWith(".htm")||a.endWith(".html"),d=c.CreateWrappedState(a,f,"",d);c.tmpStates[d.state.name]=d.state;return d};c.LayoutState=function(a,f,d){var e=a.endWith(".htm")||a.endWith(".html");d||(d="");a=c.CreateWrappedState(a,f,d,e);a.state["abstract"]=!0;a.state.controller=null;a.state.resolve=null;c.tmpStates[a.state.name]=
a.state;return a};c.ContentState=function(a,f,d){var e=a.endWith(".htm")||a.endWith(".html");d||(d=c.DefaultLayout);a=c.CreateWrappedState(a,f,d,e);c.tmpStates[a.state.name]=a.state;return a};c.MultiViewsState=function(a,f,d){var e=a.endWith(".htm")||a.endWith(".html");d||(d=c.DefaultLayout);d=c.CreateWrappedState(a,f,d,e);d.state.name="MultiViewsLayout_"+d.state.name;c.tmpStates[d.state.name]=d.state;d.state["abstract"]=!0;a=(a.startWith("/")?"":c.ns)+a;a=e?a.substring(0,a.indexOf(".")):a;0<a.indexOf("?")&&
(a=a.substring(0,a.indexOf("?")));f={name:a,url:a+(f?"?"+f:""),params:d.state.params,reloadOnSearch:!1,parent:d.state.name,views:{}};d.state.params=null;c.tmpStates[a]=f;return{state:f,BranchView:function(a,d){var e=a.endWith(".htm")||a.endWith(".html"),e=c.CreateWrappedState(a,d,void 0,e,this.state.name);e.OwnerState=this.state;e.OwnerState.views[e.state.name]=e.state;return e},Layout:d}};c.RawState=function(a){var f=c.CreateWrappedState(a);c.tmpStates[f.state.name]=a;return f};c.RegisterImplicitControllers=
function(){g.forEach(c.tmpStates,function(a,c){a.controller==p.AutoControllerMarker&&(a.controller=null!=a.resolve&&a.resolve.serverVm?["pb","serverVm","$scope",function(a,c,d){a.Super(this,c,d)}]:["pb","$scope",function(a,c){a.Super(this,{},c)}]);if(a.views)g.forEach(a.views,function(c,d){c.controller==p.AutoControllerMarker&&(c.controller=null!=c.resolve&&c.resolve.serverVm?["pb","serverVm","$scope",function(a,c,d){a.Super(this,c,d)}]:["pb","$scope",function(a,c){a.Super(this,{},c)}]);var f=c.controller;
if(f=g.isArray(f)?f[f.length-1]:f)d=a.name+".view_"+d,f.prototype._DefinedBy=f.prototype._DefinedBy||d,f.prototype._NavBackRefresh=a.Tmp_NavBackRefresh,delete a.Tmp_NavBackRefresh});else{var d=a.controller;if(d=g.isArray(d)?d[d.length-1]:d)d.prototype._DefinedBy=d.prototype._DefinedBy||a.name,d.prototype._NavBackRefresh=a.Tmp_NavBackRefresh,delete a.Tmp_NavBackRefresh}})};c.RegisterStates=function(a){g.forEach(c.tmpStates,function(c,d){a.state(c)});c.tmpStates={}}};y.$inject="validationManager $http $state $translate $parse $window $injector $timeout $q pbui".split(" ");
var w=g.module("projectbase");w.provider("pb",function(){this.$get=y});w.directive("pbInitvm",function(){return{priority:0,restrict:"A",compile:function(k,c,a){return{pre:function(a,c,e){c.controller().vm={};""!=e.pbInitvm&&g.copy(g.fromJson(e.pbInitvm),c.controller().vm)},post:function(a,c,e,g){}}}}});w.directive("pbInitData",function(){return{priority:0,restrict:"A",compile:function(k,c,a){return{pre:function(a,c,e){""!=e.pbInitData&&e.pbInitVar&&(a[e.pbInitVar]._initData=g.fromJson(e.pbInitData))},
post:function(a,c,e,g){}}}}});w.directive("ajaxUrl",["pb",function(g){return{priority:0,restrict:"A",compile:function(c,a,f){return{pre:function(a,c,f,g){},post:function(a,c,f,k){f.ngClick||f.ngSubmit||(a=function(){g.AjaxSubmit(c)},"FORM"==c.prop("tagName")?c.bind("submit",a):"BUTTON"!=c.prop("tagName")&&"A"!=c.prop("tagName")||c.bind("click",a))}}}}}]);w.directive("pbGroup",["pb",function(g){return{priority:0,restrict:"A",require:["^form","ngModel"],link:function(c,a,f,d){f.name&&(c=d[0],c.PB_Group=
c.PB_Group||{},c.PB_Group[f.pbGroup]=c.PB_Group[f.pbGroup]||{},c.PB_Group[f.pbGroup][f.name]=a)}}}])})(String,angular);
