var PB_Global_StateDefiner;
(function(K,f){function v(D,d,a,s,e,g,q,t,l,r){var c=function(b){if(f.isString(b)){var n=g.document.getElementById(b);if(n)return f.element(n);n=g.document.getElementsByName(b);return f.element(n)}return f.element(b)},x=function(b){for(;0!=b.length&&"FORM"!=b.prop("tagName")&&"NG-FORM"!=b.prop("tagName");)b=b.parent();return b},v=function(b,n,a,e,E,s){var k,h,l,f,q,m,u,t=!0;a&&(a["ajax-data"]&&(m=a["ajax-data"]),a["ajax-form"]&&(k=c(a["ajax-form"])),a["ajax-url"]&&(h=a["ajax-url"]),a["ajax-bind"]&&
(f=a["ajax-bind"]),a["ajax-processing"]&&(l=a["ajax-processing"]),a["ajax-method"]&&(q=a["ajax-method"]));if("undefined"==typeof k&&"undefined"!=typeof b)if("FORM"==c(b).prop("tagName")||"NG-FORM"==c(b).prop("tagName"))k=c(b);else{var v=c(b).attr("ajax-form");if("undefined"!=typeof v){if(""!=v&&(k=c(v),0==k.length)){g.alert("form not found,id="+v);return}}else k=x(c(b))}if("undefined"==typeof h||""==h)h=c(b).attr("ajax-url")||c(k).attr("ajax-url");if("undefined"==typeof h||""==h)return g.alert("need value for ajax-url!");
"undefined"==typeof l&&(l=c(b).attr("ajax-processing")||c(k).attr("id"));"undefined"==typeof q&&(q=c(b).attr("ajax-method")||c(k).attr("ajax-method")||"POST");"undefined"==typeof f&&(f=c(b).attr("ajax-bind")||c(k).attr("ajax-bind"));"undefined"==typeof f&&a&&!a["ajax-bind"]&&(f="nobind");if("nobind"==f)t=!1;else if("parent"==f){if(u=c(b).parent().controller(),null==u&&(u=c(k).controller()),null==u){g.alert("ajax-bind=parent targets no controller!");return}}else if("undefined"==typeof f||""==f)if(u=
c(b).controller(),null==u&&(u=c(k).controller()),null==u){g.alert("an default ajax-bind targets no controller!");return}if(t&&null==u)if("undefined"==typeof l&&(l=f),"undefined"!=typeof c(f).attr("ui-view")){if(u=c(f).children().eq(0).controller(),null==u){g.alert("bindTargetId:"+f+" targets a ui-view which has not a controller!");return}}else{g.alert("bindTargetId:"+f+" should target an ui-view !");return}var w;if(0<c(k).length){if(c(k).controller("form").$invalid){D.validateForm(k);return}w=F(k)}a=
G(w,m);h=h.split("?");h=h[0]+"?"+p.KeyForViewModelOnly+"=true"+(h[1]?"&"+h[1]:"");r.PutProcessing(l);n=d({method:q,url:h,data:a,params:n}).success(function(a,n,d,g){z(a);t&&a.IsVM&&(u.vm=a.data.ViewModel);!0==a.isRcResult?e?!0!=s&&y(a):((n=c(b).controller())&&n.ExecuteResult?n.ExecuteResult(c(b).attr("id"),a):y(a),a.IsNoop&&n&&n.ExecuteNoopResult&&n.ExecuteNoopResult(c(b).attr("id"))):!1==a.isRcResult&&A(a);r.PutProcessing(!1)}).error(function(b,a,n,c,d){r.Alert(a);r.PutProcessing(!1)});return e?
n.then(function(b){if(!0==b.data.isRcResult)return e(b.data,E)}):n},F=function(b){var a=/\r?\n/g,c=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,d=/^(?:select|textarea)/i,e=b.find("input"),l=b.find("textarea");b=b.find("select");var k=[],h=function(b,e){if(("INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName)&&b.name&&!b.disabled&&(b.checked||d.test(b.nodeName)||c.test(b.type))){var h=f.element(b).attr("name"),l=f.element(b).val();
f.isArray(l)?f.forEach(l,function(b,c){b=b.replace(a,"\r\n");k[k.length]=g.encodeURIComponent(h)+"="+g.encodeURIComponent(b)}):(l=l.replace(a,"\r\n"),"radio"==b.type&&"on"==l&&(l=""),k[k.length]=g.encodeURIComponent(h)+"="+g.encodeURIComponent(l))}};f.forEach(e,h);f.forEach(l,h);f.forEach(b,h);return k.join("&").replace(/%20/g,"+").replace(/number%3A/g,"")},y=function(b,n){n&&b.IsVM?n.vm=b.data.ViewModel:b.IsMsg?H(b.data):b.IsRedirect?a.go(b.data):b.IsAppPage&&(g.location=b.data)},A=function(b){b.IsMsg?
r.Alert(b.data):b.IsRedirect?a.go(b.data):b.IsAppPage?g.location=b.data:r.ShowCommand(b.command,b.data)},H=function(b){s(b).then(function(b){g.alert(b)},function(b){g.alert(b)})},I=function(b){for(var a=b.length,c=0;c<a;c++)if(null!=b[c]&&!1!=b[c])return!0;return!1},J=function(b,a){b||(b="ConfirmDelete");return f.isString(a)?r.Confirm(b,a):a?r.Confirm("ConfirmDeleteMulti"):r.Alert("NoRowSelected").then(function(){return!1})},G=function(b,a){if("undefined"==typeof b)return"undefined"==typeof a?"":
a;if("undefined"==typeof a)return b;if(""==b||""==a)return b+a;for(var c=b.split("&"),d=a.split("&"),e="",g="",l="",h=0;h<d.length;h++){for(var f=d[h].split("="),s=!1,r=0;r<c.length;r++)if(c[r].split("=")[0].toLowerCase()==f[0].toLowerCase()){c[r]=d[h];s=!0;break}s||""==d[h]||(l=l+d[h]+"&")}for(h=0;h<c.length;h++)g=g+c[h]+"&";g.endWith("&")&&(e=g);l.endWith("&")&&(e+=l);e.endWith("&")&&(e=e.substr(0,e.length-1));return e},B=function(b,c,e,d,g){if(e!=b){for(var l=m.Stack.length,k=0;k<l;k++)if(b==m.Stack[k].State)return;
var h,l={};c&&"undefined"!=typeof c["ajax-nav"]&&(h=f.lowercase(c["ajax-nav"]));k=f.lowercase(c["ajax-nav-back"]);if(g){if("forward"==h&&(1==m.Stack.length&&null==m.Stack[0].State&&(m.Stack[0].State=e),b=m.Stack[m.Stack.length-1],e==b.State)){c=b.State;do l[c.name]=g.c.vm,c=a.get(c.parent),g=g.$parent;while(!c.name.startWith("/Shared/"));b.StateData=l}}else"undefined"==typeof h||k||(g={PrevState:e,PrevStateParams:d,State:b,StateParams:c,StateData:null},"root"==h?(m.Stack=[w],m.Stack[0].State=b,m.Stack[0].StateParams=
c):"forward"==h?m.Stack.push(g):alert("nav has invalid value!"))}},C=function(b,a,c){a||c||(a=p.Command_AjaxNavVM,c={ViewModel:null});return{result:b,command:a,data:c}};return{AjaxSubmit:function(b,a,d,l,f,s){var k,h="";null==b&&(b=void 0);if(b&&(b=c(b),1<b.length&&(b=b.eq(0)),1>b.length)){g.alert("param control's indicated no control");return}if("undefined"!=typeof c(b).attr("ajax-confirm")||"undefined"!=typeof c(b).attr("ajax-confirm-single")||"undefined"!=typeof c(b).attr("ajax-confirm-multi"))k=
c(b).attr("ajax-confirm"),"undefined"!=typeof c(b).attr("ajax-confirm-single")?h=c(b).attr("ajax-confirm-single"):"undefined"!=typeof c(b).attr("ajax-confirm-multi")&&(h=e(c(b).attr("ajax-confirm-multi"))(c(b).scope()),h=I(h)),J(k,h).then(function(c){if(!0==c)return v(b,a,d,l,f,s)});else return v(b,a,d,l,f,s)},CallAction:function(b,a,c,e,g){b=b.split("?");b=b[0]+"?"+p.KeyForViewModelOnly+"=true"+(b[1]?"&"+b[1]:"");a=d({method:"POST",url:b,data:a}).success(function(b,a,c,e){z(b);!0==b.isRcResult&&
!0!=g?y(b):!1==b.isRcResult&&A(b)}).error(function(b,a,c,e){r.Alert(a)});return c?a.then(function(b){if(!0==b.data.isRcResult)return c(b.data,e)}):a},ExecuteResult:y,AjaxNavRegister:B,AjaxNavGetBackSrc:function(b,a){var c=a?a["ajax-nav-back"]:void 0,e=c?c.startWith("back:"):!1;if(c&&e){var d=C();d.data.ViewModel=m.Stack[m.Stack.length-1].StateData[b];return{IsBack:e,BackFrom:e?c.substring(5,c.length):void 0,LastData:d}}return!1},AjaxNavBack:function(){var b=m.Stack.pop(),c;b.PrevStateParams&&(c=f.copy(b.PrevStateParams),
c["ajax-nav-back"]="back:"+a.current.name);a.transitionTo(b.PrevState,c,{reload:!1,inherit:!1,notify:!0})},CreateRcResult:C,AjaxNavData:m,ElementById:c,Super:function(b,a,c,e){b.vm=a;b.tmp={};"undefined"==typeof e&&g.alert("param isParenState should have a value!");e||c.$on("$stateChangeStart",function(b,a,c,e,d){B(a,c,e,d,b.currentScope||{});r.PutProcessing("_view")});var d=c.$root.$state.current.data.NavBackRefresh;d&&c.$on("$viewContentLoaded",function(b){a._FromResult&&a._FromResult.command==
p.Command_AjaxNavVM&&t(function(){q.invoke(d)})});return b}}}var w={PrevState:"tobeset",PrevStateParams:null,State:null,StateParams:null,StateData:null},m={Stack:[w]},p={DefaultPopupWindowFeature:"height=600, width=600, top=50, left=300, toolbar=yes, menubar=no, scrollbars=yes, resizable=yes,location=no, status=no",AuthFailure:"_AuthFailure",AuthFailureMaskElementId:"divAuthFailureMask",KeyForViewModelOnly:"_ForViewModelOnly",Command_Noop:"Noop",Command_Message:"Message",Command_Redirect:"Redirect",
Command_AppPage:"AppPage",Command_ServerVM:"ServerVM",Command_ServerData:"ServerData",Command_AjaxNavVM:"AjaxNavVM",Command_HttpStatus:"HttpStatus",UrlMappingPrefix:"tobeset",AutoControllerMarker:"PB_Auto"},z=function(f){var d=f.command;d==p.Command_ServerVM||f.command==p.Command_AjaxNavVM?f.IsVM=!0:d==p.Command_Message?f.IsMsg=!0:d==p.Command_ServerData?f.IsData=!0:d==p.Command_Noop?f.IsNoop=!0:d==p.Command_Redirect?f.IsRedirect=!0:d==p.Command_AppPage&&(f.IsAppPage=!0)};PB_Global_StateDefiner=function(m){var d=
this;d.ns="";d.DefaultLayout="";d.tmpStates={};d.SetDefaultLayout=function(a){d.DefaultLayout=a};d.SetUrlMappingPrefix=function(a){p.UrlMappingPrefix=a};d.SetAjaxNavRootState=function(a){w.PrevState=a};d.CreateWrappedState=function(a,s,e,g){var q,t;f.isString(a)&&(t=(a.startWith("/")?"":d.ns)+a,q=g?t.substring(0,t.indexOf(".")):t,0<q.indexOf("?")&&(q=q.substring(0,q.indexOf("?"))),a={name:q,url:q+(s?"?"+s:""),templateUrl:g?t:null,controller:p.AutoControllerMarker,controllerAs:"c",params:{"ajax-nav":{value:void 0,
squash:!0,array:!1},"ajax-nav-back":{value:void 0,squash:!0,array:!1}},reloadOnSearch:!1,resolve:null,"abstract":!1,parent:"undefined"==typeof e?d.DefaultLayout:e},g||(g=["pb","$stateParams",function(a,e){var c=a.AjaxNavGetBackSrc(q,e);return c&&c.IsBack?c.LastData:!1}],s=["pb","customizedResultGetter","$stateParams",function(a,e,c){if(e)return e;e=p.UrlMappingPrefix+q;if(!e)return null;c=f.copy(c);delete c["ajax-nav"];delete c["ajax-nav-back"];return a.AjaxSubmit(null,c,{"ajax-url":e,"ajax-bind":"nobind",
"ajax-method":"GET"},function(a){return a})}],e=["pb","serverResult",function(a,e){z(e);if(e.IsVM)return e.data.ViewModel._FromResult=e,e.data.ViewModel;if(!1==e.isRcResult)throw e;return{}}],a.templateUrl=function(){return p.UrlMappingPrefix+t},a.resolve={customizedResultGetter:g,serverResult:s,serverVm:e}));a.data||(a.data={});return{state:a,WithController:function(a){a=(a.startWith("/")?"":d.ns)+a;a=d.tmpStates[a];this.state.controller=a.controller;this.state.templateUrl=a.templateUrl;this.state.templateUrlFn=
a.templateUrlFn;return this},WithChild:function(a,e){var c=a.endWith(".htm")||a.endWith(".html"),c=d.CreateWrappedState(a,e,this.state.name,c);d.tmpStates[c.state.name]=c.state;this.state["abstract"]=!0;return c},Controller:function(a){m.controller(this.state.name,a);this.state.controller=this.state.name;return this},NoController:function(){this.state.controller=null;this.state.controllerAs=null;return this},NoResolve:function(){this.state.resolve=null;return this},ResultGetter:function(a){this.state.resolve.customizedResultGetter=
a;return this},NavBackRefresh:function(a){a?this.state.data.NavBackRefresh=a:this.state.resolve.customizedResultGetter=function(){return!1};return this},ForceRefreshTemplate:function(a){a||(a=this.state.name);this.state.templateUrl=p.UrlMappingPrefix+a+"?"+p.KeyForViewModelOnly+"=false";this.state.templateFn=null;return this}}};d.RootState=function(a,f){var e=a.endWith(".htm")||a.endWith(".html"),e=d.CreateWrappedState(a,f,"",e);d.tmpStates[e.state.name]=e.state;return e};d.RootStateNoResolve=function(a,
f){var e=a.endWith(".htm")||a.endWith(".html"),e=d.CreateWrappedState(a,f,"",e);e.state.resolve=null;d.tmpStates[e.state.name]=e.state;return e};d.LayoutState=function(a,f,e){var g=a.endWith(".htm")||a.endWith(".html");e||(e="");a=d.CreateWrappedState(a,f,e,g);a.state["abstract"]=!0;a.state.controller=null;a.state.resolve=null;d.tmpStates[a.state.name]=a.state;return a};d.ContentState=function(a,f,e){var g=a.endWith(".htm")||a.endWith(".html");e||(e=d.DefaultLayout);a=d.CreateWrappedState(a,f,e,g);
d.tmpStates[a.state.name]=a.state;return a};d.RawState=function(a){var f=d.CreateWrappedState(a);d.tmpStates[f.state.name]=a;return f};d.RegisterImplicitControllers=function(){f.forEach(d.tmpStates,function(a,d){a.controller==p.AutoControllerMarker&&(a["abstract"]?m.controller(d,["serverVm",function(a){this.vm=a}]):m.controller(d,["pb","serverVm","$scope",function(a,d,f){a.Super(this,d,f,!1)}]),a.controller=d)})};d.RegisterStates=function(a){f.forEach(d.tmpStates,function(d,e){a.state(d)});d.tmpStates=
{}}};v.$inject="validationManager $http $state $translate $parse $window $injector $timeout $q pbui".split(" ");var x=f.module("projectbase");x.provider("pb",function(){this.$get=v});x.directive("pbInitvm",function(){return{priority:0,restrict:"A",compile:function(m,d,a){return{pre:function(a,e,d){e.controller().vm={};""!=d.pbInitvm&&f.copy(f.fromJson(d.pbInitvm),e.controller().vm)},post:function(a,e,d,f){}}}}});x.directive("pbInitData",function(){return{priority:0,restrict:"A",compile:function(m,
d,a){return{pre:function(a,e,d){""!=d.pbInitData&&d.pbInitVar&&(a[d.pbInitVar]._initData=f.fromJson(d.pbInitData))},post:function(a,e,d,f){}}}}});x.directive("ajaxUrl",["pb",function(f){return{priority:0,restrict:"A",compile:function(d,a,m){return{pre:function(a,d,f,m){},post:function(a,d,m,p){m.ngClick||m.ngSubmit||(a=function(){f.AjaxSubmit(d)},"FORM"==d.prop("tagName")?d.bind("submit",a):"BUTTON"!=d.prop("tagName")&&"A"!=d.prop("tagName")||d.bind("click",a))}}}}}])})(String,angular);
